{% extends 'base.html' %}
{% block extra_head %}
    <meta name="description" content="{{ product.name }} - SDR World product details.">
    <meta name="keywords" content="SDR, product, review, rating, {{ product.brand }}">
    <meta name="author" content="SDR World Team">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="{{ product.name }} - SDR World">
{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6">
            {% if product.image %}
                <img src="{{ product.image.url }}" class="img-fluid mb-3" alt="{{ product.name }}">
            {% endif %}
        </div>
        <div class="col-md-6">
            <h2>{{ product.name }}</h2>
            <p><strong>Brand:</strong> {{ product.brand }}</p>
            <p><strong>Price:</strong> ${{ product.price }}</p>
            <p>{{ product.description }}</p>
            <div class="mb-3">
                <strong>Average Rating:</strong>
                <span id="avg-rating">{{ avg_rating|floatformat:1 }}</span> / 5
                <span class="text-warning">
                    {% for i in "12345" %}
                        {% if i|add:'0' <= avg_rating %}
                            <i class="bi bi-star-fill"></i>
                        {% else %}
                            <i class="bi bi-star"></i>
                        {% endif %}
                    {% endfor %}
                </span>
            </div>
        </div>
    </div>
    <hr>
    <div class="row mt-4">
        <div class="col-md-6">
            <h4>Reviews</h4>
            <div id="reviews-list">
                {% for review in reviews %}
                    <div class="border rounded p-2 mb-2">
                        <strong>{{ review.user.username }}</strong> - <span class="text-warning">{% for i in "12345" %}{% if i|add:'0' <= review.rating %}<i class="bi bi-star-fill"></i>{% else %}<i class="bi bi-star"></i>{% endif %}{% endfor %}</span>
                        <small class="text-muted">{{ review.created_at|date:"Y-m-d H:i" }}</small>
                        <div>{{ review.comment }}</div>
                    </div>
                {% empty %}
                    <p>No reviews yet.</p>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <h4>Write a Review</h4>
            {% if user.is_authenticated %}
                <form id="review-form" method="post">
                    {% csrf_token %}
                    {% load crispy_forms_tags %}
                    {{ review_form|crispy }}
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
                <div id="review-success" class="alert alert-success d-none mt-2"></div>
                <div id="review-error" class="alert alert-danger d-none mt-2"></div>
            {% else %}
                <p><a href="{% url 'login' %}?next={{ request.path }}">Login</a> to write a review.</p>
            {% endif %}
        </div>
    </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function() {
    $('#review-form').on('submit', function(e) {
        e.preventDefault();
        var $form = $(this);
        $.ajax({
            url: "{% url 'submit_review' %}",
            method: 'POST',
            data: $form.serialize(),
            success: function(data) {
                $('#review-success').removeClass('d-none').text('Review submitted!');
                $('#review-error').addClass('d-none');
                // Add new review to the top
                var stars = '';
                for (var i = 1; i <= 5; i++) {
                    stars += i <= data.rating ? '<i class="bi bi-star-fill text-warning"></i>' : '<i class="bi bi-star"></i>';
                }
                var reviewHtml = '<div class="border rounded p-2 mb-2">' +
                    '<strong>' + data.user + '</strong> - <span class="text-warning">' + stars + '</span> ' +
                    '<small class="text-muted">' + data.created_at + '</small>' +
                    '<div>' + data.comment + '</div>' +
                    '</div>';
                $('#reviews-list').prepend(reviewHtml);
                $form[0].reset();
            },
            error: function(xhr) {
                $('#review-error').removeClass('d-none').text('Error: ' + (xhr.responseJSON && xhr.responseJSON.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Could not submit review.'));
                $('#review-success').addClass('d-none');
            }
        });
    });
});
</script>
{% endblock %} 